<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:insert="~{/fragments/general.html :: head(title=#{singleton.sign_up})}">
</head>
<body>
    <header th:insert="~{/fragments/general.html :: header}"></header>

    <div class="px-5 py-3">
        <a th:href="@{/oauth2/authorization/google}">
            <button class="btn btn-primary mb-2">Google</button>
        </a>

        <div class="divider">
            <span>or</span>
        </div>

        <form class="needs-validation" autocomplete="off" th:action="@{/signup}" method="post" th:object="${signupForm}" novalidate>
            <div class="form-group username-group">
                <label for="username" th:text="#{singleton.username}">Username</label>
                <input type="text" th:field="*{username}" class="form-control" th:classappend="${#fields.hasErrors('username') ? 'is-invalid' : ''}"
                       id="username" th:placeholder="#{placeholder.username}" required>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('username')}" th:errors="*{username}"></div>
            </div>

            <div class="form-group email-group">
                <label for="email" th:text="#{singleton.email}">Email</label>
                <input type="email" th:field="*{email}" class="form-control" id="email" th:placeholder="#{placeholder.email}" required>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></div>
            </div>

            <div class="form-group pwd-group">
                <label for="pwd" th:text="#{singleton.password}">Password</label>
                <input type="password" th:field="*{password}" class="form-control" id="pwd" th:placeholder="#{placeholder.password}" required>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('password')}" th:errors="*{password}"></div>
            </div>

    <!--        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">-->
            <button type="submit" class="btn btn-primary">Create Account</button>
        </form>

        <p class="mt-2">Already signed up? <a href="/login">Log in</a> instead.</p>
    </div>

    <script th:inline="javascript">
        const form = document.querySelector(".needs-validation");
        const nameGroup = document.querySelector(".username-group");
        const nameReg = /^[a-zA-Z0-9._$-]+$/;
        const emailGroup = document.querySelector(".email-group");
        const emailReg = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        const pwdGroup = document.querySelector(".pwd-group");

        nameGroup.querySelector("#username").addEventListener('focusout', checkUsername);
        function checkUsername(emptyFine = true) {
            let valid = true;
            const userInput = nameGroup.querySelector("#username");
            const username = userInput.value;
            const label = nameGroup.querySelector("label[for='username']");

            if (username.length == 0 && emptyFine) {
                empty(userInput, label, /*[[#{singleton.username}]]*/ "");
                valid = false;
            }
            else if (!nameReg.test(username)) {
                invalidated(userInput, label, /*[[#{error.register.username_chars}]]*/ "");
                valid = false;
            }
            else if (username.length < 4 || username.length > 32) {
                invalidated(userInput, label, /*[[#{error.register.username_size}]]*/ "");
                valid = false;
            }
            else {
                empty(userInput, label, /*[[#{singleton.username}]]*/ "");
                valid = true;
            }
            return valid;
        }

        emailGroup.querySelector("#email").addEventListener('focusout', checkEmail);
        function checkEmail(emptyFine = true) {
            let valid = true;
            const emailInput = emailGroup.querySelector("#email");
            const email = emailInput.value;
            const label = emailGroup.querySelector("label[for='email']");

            if (email.length == 0 && emptyFine) {
                empty(emailInput, label, /*[[#{singleton.email}]]*/ "");
                valid = false;
            }
            else if (!emailReg.test(email)) {
                invalidated(emailInput, label, /*[[#{error.register.email_valid}]]*/ "");
                valid = false;
            }
            else {
                empty(emailInput, label, /*[[#{singleton.email}]]*/ "");
                valid = true;
            }
            return valid;
        }
        
        pwdGroup.querySelector("#pwd").addEventListener('focusout', checkPwd);
        function checkPwd(emptyFine = true) {
            let valid = true;
            const pwdInput = pwdGroup.querySelector("#pwd");
            const pwd = pwdInput.value;
            const label = pwdGroup.querySelector("label[for='pwd']");

            if (pwd.length == 0 && emptyFine) {
                empty(pwdInput, label, /*[[#{singleton.pwd}]]*/ "");
                valid = false;
            }
            else if (pwd.length < 8 || pwd.length > 128) {
                invalidated(pwdInput, label, /*[[#{error.register.password_size}]]*/ "");
                valid = false;
            }
            else {
                empty(pwdInput, label, /*[[#{singleton.password}]]*/ "");
                valid = true;
            }
            return valid;
        }
        

        function invalidated(input, label, text) {
            input.classList.remove("is-valid");
            input.classList.add("is-invalid");
            label.textContent = text;
            label.style.color = "red";
        }
        function empty(input, label, text) {
            input.classList.remove("is-invalid");
            input.classList.remove("is-valid");
            label.style.color = "inherit";
            label.textContent = text;
        }
        function validated(input, label, text) {
            input.classList.remove("is-invalid");
            input.classList.add("is-valid");
            label.style.color = "inherit";
            label.textContent = text;
        }

        form.addEventListener('submit', (event) => {
            if (!form.checkValidity() || !checkPwd(false) || !checkEmail(false) || !checkUsername(false)) {
              event.preventDefault();
              event.stopPropagation();
            }
            //form.classList.add('was-validated');
         });
    </script>
</body>
</html>