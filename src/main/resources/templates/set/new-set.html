<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:insert="~{/fragments/general.html :: head(title=#{singleton.new_set})}">
</head>
<body>
<header th:insert="~{/fragments/general.html :: header}"></header>

<form class="set-form px-5 py-3 needs-validation" autocomplete="off" th:action="@{/new-set}" method="post" th:object="${setForm}" novalidate>
    <div class="form-group">
        <label for="title">Title</label>
        <input type="text" class="form-control user-select-none" id="title" th:field="*{name}" placeholder="Pets" required>
        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
        <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('flashcards')}" th:errors="*{flashcards}"></div>
        <div class="invalid-feedback warning"><span th:text="#{errors.set.size}"></span></div>
    </div>

    <div class="row form-group card-form template">
        <div class="col">
            <label for="term">Term</label>
            <input type="text" class="form-control term user-select-none" id="term" placeholder="Cats">
        </div>
        <div class="col">
            <label for="definition">Definition</label>
            <input type="text" class="form-control definition user-select-none" id="definition" placeholder="Little guys">
        </div>
    </div>

    <div class="form-group card-button">
        <button type="button" class="btn btn-primary rounded d-block w-100">
            <svg class="mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="-32 0 512 512">
                <path fill="currentColor" d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/>
            </svg>
        </button>
    </div>

<!--        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>-->

    <div class="form-group">
        <button type="submit" class="btn btn-primary rounded d-block ms-auto">
            Create Set
        </button>
    </div>
</form>

<footer th:insert="~{/fragments/general.html :: footer}"></footer>

<script th:inline="javascript">

    const form = document.querySelector(".needs-validation");
    form.addEventListener('submit', (event) => {
        if (!form.checkValidity() || !checkTitle() || !checkCards()) {
          event.preventDefault();
          event.stopPropagation();
        }
        //form.classList.add('was-validated');
     });

    function checkCards() {
        let numCards = 0;
        document.querySelectorAll(".card-form:not(.template)").forEach((card, ind) => {
            if (card.querySelector("#term" + ind).value.length > 0 || card.querySelector("#definition" + ind).value.length > 0) {
                numCards++;
            }
        });
        const warning = document.querySelector(".warning");
        if (numCards >= 3) {
            warning.classList.remove("d-block");
            return true;
        }
        warning.classList.add("d-block");
        return false;
    }


    document.querySelector("#title").addEventListener('focusout', checkTitle);
    function checkTitle() {
        let valid = true;
        const nameInput = document.querySelector("#title");
        const name = nameInput.value;
        const label = document.querySelector("label[for='title']");
        if (name.length <= 0) {
            invalidated(nameInput, label, /*[[#{errors.set.name}]]*/ "");
            valid = false;
        }
        else {
            empty(nameInput, label, /*[[#{singleton.title}]]*/ "");
            valid = true;
        }
        return valid;
    }

    let numCards = 0;
    const cardTemplate = document.querySelector(".card-form.template");
    const cardButton = document.querySelector(".card-button");
    for (let i = 0; i < 3; i++) {
        addCard();
    }

    cardButton.onclick = addCard;
    function addCard() {
      let newCard = cardTemplate.cloneNode(true);
      newCard.classList.remove("template");
      newCard.querySelectorAll("label").forEach((label) => label.htmlFor = label.htmlFor + numCards);
      newCard.querySelectorAll("input").forEach((input) => input.id = input.id + numCards);
      newCard.querySelector(".term").name = "term";
      newCard.querySelector(".definition").name = "definition";

      numCards++;

      cardButton.before(newCard);
    }

    function invalidated(input, label, text) {
        input.classList.remove("is-valid");
        input.classList.add("is-invalid");
        label.textContent = text;
        label.style.color = "red";
    }
    function empty(input, label, text) {
        input.classList.remove("is-invalid");
        input.classList.remove("is-valid");
        label.style.color = "inherit";
        label.textContent = text;
    }
    function validated(input, label, text) {
        input.classList.remove("is-invalid");
        input.classList.add("is-valid");
        label.style.color = "inherit";
        label.textContent = text;
    }
</script>

</body>
</html>